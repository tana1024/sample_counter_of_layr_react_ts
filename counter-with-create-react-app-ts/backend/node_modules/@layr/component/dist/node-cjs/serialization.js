"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.serializeFunction = exports.serialize = void 0;
const simple_serialization_1 = require("simple-serialization");
const possibly_async_1 = require("possibly-async");
const core_helpers_1 = require("core-helpers");
const utilities_1 = require("./utilities");
function serialize(value, options = {}) {
    const { serializedComponents = new Set(), objectSerializer: originalObjectSerializer, functionSerializer: originalFunctionSerializer, serializeFunctions = false, ...otherOptions } = options;
    const objectSerializer = function (object) {
        if (originalObjectSerializer !== undefined) {
            const serializedObject = originalObjectSerializer(object);
            if (serializedObject !== undefined) {
                return serializedObject;
            }
        }
        if (utilities_1.isComponentClassOrInstance(object)) {
            return object.serialize({ ...options, serializedComponents });
        }
    };
    let functionSerializer;
    if (serializeFunctions) {
        functionSerializer = function (func) {
            if (originalFunctionSerializer !== undefined) {
                const serializedFunction = originalFunctionSerializer(func);
                if (serializedFunction !== undefined) {
                    return serializedFunction;
                }
            }
            if (core_helpers_1.isES2015Class(func)) {
                throw new Error('Cannot serialize a class');
            }
            const functionCode = serializeFunction(func);
            const serializedFunction = { __function: functionCode };
            return possibly_async_1.possiblyAsync(possibly_async_1.possiblyAsync.mapValues(func, (attributeValue) => simple_serialization_1.serialize(attributeValue, { ...otherOptions, objectSerializer, functionSerializer })), (serializedAttributes) => {
                Object.assign(serializedFunction, serializedAttributes);
                return serializedFunction;
            });
        };
    }
    return simple_serialization_1.serialize(value, { ...otherOptions, objectSerializer, functionSerializer });
}
exports.serialize = serialize;
function serializeFunction(func) {
    let sourceCode = func.toString();
    // Clean functions generated by `new Function()`
    if (sourceCode.startsWith('function anonymous(\n)')) {
        sourceCode = 'function ()' + sourceCode.slice('function anonymous(\n)'.length);
    }
    return sourceCode;
}
exports.serializeFunction = serializeFunction;
//# sourceMappingURL=serialization.js.map