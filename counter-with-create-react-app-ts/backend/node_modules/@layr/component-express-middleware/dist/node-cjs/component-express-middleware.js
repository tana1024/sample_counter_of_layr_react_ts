"use strict";
/**
 * @module component-express-middleware
 *
 * An [Express](https://expressjs.com/) middleware allowing to serve a root [`Component`](https://layrjs.com/docs/v1/reference/component) so it can be accessed by a [`ComponentHTTPClient`](https://layrjs.com/docs/v1/reference/component-http-client).
 *
 * #### Usage
 *
 * Call the [`serveComponent()`](https://layrjs.com/docs/v1/reference/component-express-middleware#serve-component-function) function to create a middleware for your Express application.
 *
 * **Example:**
 *
 * ```
 * import express from 'express';
 * import {Component} from '@layr/component';
 * import {serveComponent} from '@layr/component-express-middleware';
 *
 * class Movie extends Component {
 *   // ...
 * }
 *
 * const app = express();
 *
 * app.use('/api', serveComponent(Movie));
 *
 * app.listen(3210);
 * ```
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.serveComponent = void 0;
const tslib_1 = require("tslib");
const component_server_1 = require("@layr/component-server");
const co_body_1 = tslib_1.__importDefault(require("co-body"));
const http_errors_1 = tslib_1.__importDefault(require("http-errors"));
const sleep_promise_1 = tslib_1.__importDefault(require("sleep-promise"));
const DEFAULT_LIMIT = '8mb';
/**
 * Creates an [Express](https://expressjs.com/) middleware exposing the specified root [`Component`](https://layrjs.com/docs/v1/reference/component) class.
 *
 * @param componentOrComponentServer The root [`Component`](https://layrjs.com/docs/v1/reference/component) class to serve. An instance of a [`ComponentServer`](https://layrjs.com/docs/v1/reference/component-server) will be created under the hood. Alternatively, you can pass an existing instance of a [`ComponentServer`](https://layrjs.com/docs/v1/reference/component-server).
 * @param [options.version] A number specifying the version of the created [`ComponentServer`](https://layrjs.com/docs/v1/reference/component-server) (default: `undefined`).
 *
 * @returns An Express middleware.
 *
 * @category Functions
 */
function serveComponent(componentOrComponentServer, options = {}) {
    const componentServer = component_server_1.ensureComponentServer(componentOrComponentServer, options);
    const { limit = DEFAULT_LIMIT, delay = 0, errorRate = 0 } = options;
    return async function (request, response) {
        if (delay > 0) {
            await sleep_promise_1.default(delay);
        }
        if (errorRate > 0) {
            const threshold = errorRate / 100;
            if (Math.random() < threshold) {
                throw http_errors_1.default(500, 'A simulated error occurred while handling a component server query');
            }
        }
        if (request.url !== '/') {
            throw http_errors_1.default(404);
        }
        if (request.method === 'GET') {
            response.json(await componentServer.receive({ query: { 'introspect=>': { '()': [] } } }));
            return;
        }
        if (request.method === 'POST') {
            const { query, components, version } = await co_body_1.default.json(request, { limit, strict: true });
            response.json(await componentServer.receive({ query, components, version }));
            return;
        }
        throw http_errors_1.default(405);
    };
}
exports.serveComponent = serveComponent;
//# sourceMappingURL=component-express-middleware.js.map